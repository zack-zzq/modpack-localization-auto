name: Auto Release Translated Packs

on:
  push:
    paths:
      - 'output/**/*.zip'
    branches:
      - main
      - master
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Release Body
        id: body
        run: |
          echo "BODY_TEXT<<EOF" >> $GITHUB_ENV
          echo "## ðŸŽ‰ æ•´åˆåŒ…æ±‰åŒ–æ›´æ–°" >> $GITHUB_ENV
          echo "æœ¬æ¬¡å‘å¸ƒåŒ…å«ä»¥ä¸‹æ•´åˆåŒ…çš„è‡ªåŠ¨æœ¬åœ°åŒ–ç”Ÿæˆæ–‡ä»¶ï¼š" >> $GITHUB_ENV
          echo "" >> $GITHUB_ENV
          
          for dir in output/*; do
            if [ -d "$dir" ] && [ -f "$dir/version.json" ]; then
              PACK_NAME=$(cat "$dir/version.json" | jq -r '.name')
              PACK_VERSION=$(cat "$dir/version.json" | jq -r '.version')
              MC_VERSION=$(cat "$dir/version.json" | jq -r '.mc_version')
              SLUG=$(cat "$dir/version.json" | jq -r '.slug')
              
              echo "### ðŸŽ® $PACK_NAME" >> $GITHUB_ENV
              echo "- **æ•´åˆåŒ…ç‰ˆæœ¬:** \`$PACK_VERSION\`" >> $GITHUB_ENV
              echo "- **Minecraft ç‰ˆæœ¬:** \`$MC_VERSION\`" >> $GITHUB_ENV
              echo "- **æ–‡ä»¶åˆ—è¡¨:**" >> $GITHUB_ENV
              echo "  - \`${SLUG}-localization-resourcepack.zip\`: æ”¾å…¥ \`resourcepacks\` æ–‡ä»¶å¤¹å¹¶åœ¨æ¸¸æˆå†…å¯ç”¨ï¼ˆç½®äºŽé¡¶å±‚ï¼‰ã€‚" >> $GITHUB_ENV
              echo "  - \`${SLUG}-localization-overrides.zip\`: è§£åŽ‹å¹¶è¦†ç›–åˆ°å®¢æˆ·ç«¯æ ¹ç›®å½•ï¼Œç”¨äºŽæ±‰åŒ– FTB Quests ç­‰é…ç½®æ–‡ä»¶ã€‚" >> $GITHUB_ENV
              echo "" >> $GITHUB_ENV
            fi
          done
          
          echo "EOF" >> $GITHUB_ENV

      - name: Get Short SHA
        id: slug
        run: echo "SHA8=$(echo ${GITHUB_SHA} | cut -c1-8)" >> $GITHUB_ENV

      - name: Publish Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: localization-update-${{ env.SHA8 }}
          name: Modpack Localization Update ${{ env.SHA8 }}
          body: ${{ env.BODY_TEXT }}
          files: output/**/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
